---
layout: post
title:  "자바 ORM 표준 JPA 프로그래밍 스터디 1회"
author: Aeee
date:   2021-07-25 14:29:49 +0900
categories: JPA
tags: JPA
image: /assets/images/jpa/jpa.jpg
---

# JPA 소개

## SQL을 직접 다룰 때 발생하는 문제점

- 진정한 의미의 계층 분할이 어려워진다.<br/>
  => 어떤 SQL이 실행되고 어떤 객체들이 함께 조회되는지 일일이 확인해야한다.
- 엔티티를 신뢰할 수 없다. <br/>
  => [질문] 객체 그래프 탐색의 신뢰??
- SQL에 의존적인 개발을 피하기 어렵다.<br/>
  => 엔티디와 SQL의 의존적인 관계가 강하게 결합되어서

[질문] entity의 정의는?

## 패러다임의 불일

1. 상속: 객체지향은 상속이 있지만, RDB에는 상속이 없다.<br/>
   => JPA에는 각 insert문을 실행하여 해결해준다.
2. 연관관계: 객체는 참조를 사용, 테이블은 외래키를 사용한다. 이는 객체는 단방향 참조지만, 테이블은 양방향이 가능하다.</br>
   => 개발자가 테이블에 맞게 객체를 모델링 한다면, 직접 연관관계를 설정해줘야한다.</br>
   => JPA에서는 자동으로 연관관계에 대해서 저장하고 조회한다.
3. 객체의 그래프 탐색의 범위를 알기 위해서는 SQL을 직접 봐야한다.</br>
   => JPA는 지연로딩을 기본으로 제공한다.
4. 객체는 identity와 equality로 두 가지 비교방법이 있다.</br>
   => [질문] JPA는 어떻게 동일성 비교를 지원하는가??
   
## 왜 JPA를 사용해야하는가?
- 생산성
- 유지보수
- 패러다임 불일치 해결
- 성능 => [질문] n+1? 통계적 sql?? => JPA가 제공하는 네이티브 SQL이 더 좋나??
- 데이터 접근 추상화와 벤더 독립성 => DB마다 SQL이 다르다.

# 영속성 관리

## 엔티티 매니저 팩토리와 엔티티 매니저
엔티티 매니저는 엔티티를 저장하고, 수정하고, 삭제하고, 조회하는 등 엔테티 관련된 모든 일을
처리한다.
- 엔티티 매니저 팩토리는 thread-safe 하지만, 엔티티 매니저는 thread-safe 하지 않는다.
- 엔티티 매니저는 데이터베이스의 연결이 필요할 때(lazy) 커넥션을 얻는다.(보통 트랜잭션을 시작할 때 커넥션을 얻는다.)

## 영속성 컨텍스트
Persistence Context: 엔티티를 영구 저장하는 환

## 엔티티의 생명주기
- 비영속(new/transient)
- 영속(managed)
- 준영속(detached)
- 삭제(removed)

## 영속성 컨텍스트와 식별자의 값
- 영속 상태는 식별자 값(@ID)이 반드시 있어야 한다.
- 대부분 트랜잭션이 커밋하는 순간 영속성 컨텍스트에 DB에 반영되며 이를 flush라 한다.
- 1차 캐시, 동일성 보장, 트랜잭션을 지원하는 쓰기 지연, 변경 감지, 지연 로딩 등의 장점

## 엔티티 수정의 변경감지
영속성 컨텍스트에 보관할 때, 최초 상태를 복사해서 저장하는 이것을 스냅샷이라 한다. 그리고
플러시 시점에 스냅샷과 엔티티를 비교해서 변경된 엔티티를 찾는다.
1. 트랜잭션을 커밋하면 엔티티 매니저 내부에서 먼저 플러시가 호출
2. 엔티티와 스냅샷을 비교해서 변경도니 엔티티를 찾음
3. 변경된 엔티티가 있으면 수정 쿼리를 생성해서 쓰기 지연 SQL 저장소에 보낸다.
4. 쓰기 지연 저장소의 SQL을 데이터베이스에 보낸다.
5. 데이터베이스 태랜잭션을 커밋한다.

참고 @DynamicUpdate, @DynamicInsert

## 플러시
플러시는 영속성 컨텍스으틔 변경 내용을 데이터베이스에 반영한다. 다음과 같은 일을한다.
1. 변경감지가 동작해서 영속성 컨텍스트에 있는 모든 엔티티를 스냅샷과 비교해서 수정된 엔티티는 수정 쿼리를 만들어 쓰기 지연 SQL 저장소 등록한다.
2. 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송한다.

플러시를 invoke하는 방법
- em.flush()
- 트랜직션 커밋 시 플러시가 자동 호출
- JPQL 쿼리 실행 시 플러시가 자동 호출

### 플러스 모드 옵션
- FlushModeType.AUTO
- FlushModeType.COMMIT